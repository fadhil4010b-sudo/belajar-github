// ToDoListPremium.jsx
// Single-file React component (default export) for a "premium" To‑Do List app.
// Features:
// - Add / Edit / Delete tasks
// - Mark complete / toggle
// - Priority, tags, due date
// - Search, filter (All / Active / Completed), sort (Due date / Priority)
// - Persistent storage via localStorage
// - Small animations via Framer Motion
// - Tailwind CSS utility classes (expects Tailwind configured)
// - Uses shadcn/ui & lucide-react in imports for niceness (optional — fallback to plain elements if not installed)

import React, { useEffect, useState, useRef } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Plus, Edit2, Trash2, Check, Calendar, Tag, Zap } from "lucide-react";
// If you use shadcn/ui in your project, the imports below are helpful. If not, the component will still work.
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Popover, PopoverContent, PopoverTrigger } from "@/components/ui/popover";

const STORAGE_KEY = "todo_premium_v1";

const defaultTasks = [
  {
    id: Date.now(),
    title: "Contoh tugas: Selesaikan latihan",
    notes: "Jangan lupa sertakan screenshot",
    due: null,
    priority: "Medium",
    tags: ["pelatihan"],
    done: false,
    createdAt: Date.now(),
  },
];

function uid() {
  return Math.floor(Math.random() * 1e9).toString(36);
}

export default function ToDoListPremium() {
  const [tasks, setTasks] = useState(() => {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      return raw ? JSON.parse(raw) : defaultTasks;
    } catch (e) {
      return defaultTasks;
    }
  });

  const [q, setQ] = useState("");
  const [filter, setFilter] = useState("all"); // all, active, done
  const [sortBy, setSortBy] = useState("created"); // created, due, priority
  const [editing, setEditing] = useState(null); // task id or null
  const titleRef = useRef(null);

  useEffect(() => {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
  }, [tasks]);

  useEffect(() => {
    if (editing && titleRef.current) titleRef.current.focus();
  }, [editing]);

  function addTask(payload) {
    const t = {
      id: uid(),
      title: payload.title || "Untitled",
      notes: payload.notes || "",
      due: payload.due || null,
      priority: payload.priority || "Low",
      tags: payload.tags || [],
      done: false,
      createdAt: Date.now(),
    };
    setTasks((s) => [t, ...s]);
  }

  function updateTask(id, updates) {
    setTasks((s) => s.map((t) => (t.id === id ? { ...t, ...updates } : t)));
  }

  function removeTask(id) {
    setTasks((s) => s.filter((t) => t.id !== id));
  }

  function toggleDone(id) {
    setTasks((s) => s.map((t) => (t.id === id ? { ...t, done: !t.done } : t)));
  }

  function clearCompleted() {
    setTasks((s) => s.filter((t) => !t.done));
  }

  // Filters + Search + Sort
  const visible = tasks
    .filter((t) => {
      if (filter === "active") return !t.done;
      if (filter === "done") return t.done;
      return true;
    })
    .filter((t) => {
      if (!q) return true;
      const s = q.toLowerCase();
      return (
        t.title.toLowerCase().includes(s) ||
        (t.notes && t.notes.toLowerCase().includes(s)) ||
        (t.tags && t.tags.join(" ").toLowerCase().includes(s))
      );
    })
    .sort((a, b) => {
      if (sortBy === "due") {
        if (!a.due && !b.due) return b.createdAt - a.createdAt;
        if (!a.due) return 1;
        if (!b.due) return -1;
        return new Date(a.due) - new Date(b.due);
      }
      if (sortBy === "priority") {
        const order = { High: 0, Medium: 1, Low: 2 };
        return order[a.priority] - order[b.priority];
      }
      // created
      return b.createdAt - a.createdAt;
    });

  return (
    <div className="max-w-3xl mx-auto p-6">
      <header className="mb-6">
        <h1 className="text-3xl font-extrabold">ToDoList <span className="text-indigo-500">Premium</span></h1>
        <p className="text-sm text-muted-foreground mt-1">Cepat, rapi, dan persistent — buat bukti pelatihanmu.</p>
      </header>

      <main className="bg-white shadow-md rounded-2xl p-6">
        <NewTaskForm onAdd={addTask} />

        <div className="mt-4 flex gap-3 flex-wrap items-center">
          <Input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder="Cari tugas, notes, atau tag..."
          />

          <div className="flex gap-2">
            <select
              className="px-3 py-2 rounded-md border"
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
            >
              <option value="all">Semua</option>
              <option value="active">Aktif</option>
              <option value="done">Selesai</option>
            </select>

            <select
              className="px-3 py-2 rounded-md border"
              value={sortBy}
              onChange={(e) => setSortBy(e.target.value)}
            >
              <option value="created">Terbaru</option>
              <option value="due">Tanggal Jatuh Tempo</option>
              <option value="priority">Prioritas</option>
            </select>

            <Button onClick={() => { setTasks([]); localStorage.removeItem(STORAGE_KEY); }}>
              Reset
            </Button>

            <Button onClick={clearCompleted}>
              Hapus Selesai
            </Button>
          </div>
        </div>

        <section className="mt-6">
          <AnimatePresence>
            {visible.length === 0 ? (
              <motion.div
                initial={{ opacity: 0, y: 6 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -6 }}
                className="py-8 text-center text-sm text-muted-foreground"
              >
                Tidak ada tugas.
              </motion.div>
            ) : (
              <ul className="space-y-3">
                {visible.map((t) => (
                  <motion.li
                    key={t.id}
                    initial={{ opacity: 0, y: 8 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, y: -8 }}
                    className={`flex items-start gap-4 p-4 rounded-xl border ${t.done ? 'opacity-60' : ''}`}
                  >
                    <div className="flex-shrink-0">
                      <button
                        className={`w-9 h-9 rounded-full flex items-center justify-center border ${t.done ? 'bg-green-100' : ''}`}
                        onClick={() => toggleDone(t.id)}
                        aria-label="toggle done"
                      >
                        {t.done ? <Check size={16} /> : <Zap size={16} />}
                      </button>
                    </div>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between gap-3">
                        <div>
                          <h3 className={`font-semibold truncate ${t.done ? 'line-through' : ''}`}>{t.title}</h3>
                          <div className="text-xs text-muted-foreground truncate">{t.notes}</div>
                        </div>

                        <div className="flex items-center gap-2">
                          {t.due && (
                            <div className="text-xs flex items-center gap-1">
                              <Calendar size={14} /> <span>{new Date(t.due).toLocaleDateString()}</span>
                            </div>
                          )}
                          <div className="text-xs px-2 py-1 rounded-md border">{t.priority}</div>
                          <div className="flex gap-1">
                            {t.tags.map((tg) => (
                              <div key={tg} className="text-xs px-2 py-1 rounded-md border">#{tg}</div>
                            ))}
                          </div>
                        </div>
                      </div>

                      <div className="mt-3 flex items-center gap-2">
                        <button
                          className="text-sm px-2 py-1 rounded-md border flex items-center gap-2"
                          onClick={() => setEditing(t.id)}
                        >
                          <Edit2 size={14} /> Edit
                        </button>

                        <button
                          className="text-sm px-2 py-1 rounded-md border flex items-center gap-2"
                          onClick={() => removeTask(t.id)}
                        >
                          <Trash2 size={14} /> Hapus
                        </button>

                        <small className="text-xs text-muted-foreground">Dibuat: {new Date(t.createdAt).toLocaleString()}</small>
                      </div>

                      {editing === t.id && (
                        <div className="mt-3">
                          <EditTaskForm
                            task={t}
                            onSave={(upd) => {
                              updateTask(t.id, upd);
                              setEditing(null);
                            }}
                            onCancel={() => setEditing(null)}
                          />
                        </div>
                      )}
                    </div>
                  </motion.li>
                ))}
              </ul>
            )}
          </AnimatePresence>
        </section>

      </main>

      <footer className="text-center mt-6 text-sm text-muted-foreground">Small project • Persistent via localStorage • Made with ❤️</footer>
    </div>
  );
}


function NewTaskForm({ onAdd }) {
  const [open, setOpen] = useState(true);
  const [title, setTitle] = useState("");
  const [notes, setNotes] = useState("");
  const [due, setDue] = useState("");
  const [priority, setPriority] = useState("Medium");
  const [tags, setTags] = useState("");

  function submit(e) {
    e.preventDefault();
    if (!title.trim()) return;
    onAdd({ title: title.trim(), notes: notes.trim(), due: due || null, priority, tags: tags ? tags.split(",").map(s => s.trim()) : [] });
    setTitle(""); setNotes(""); setDue(""); setPriority("Medium"); setTags("");
  }

  return (
    <form onSubmit={submit} className="rounded-lg border p-4">
      <div className="flex gap-3 items-start">
        <input
          className="flex-1 rounded-md border px-3 py-2"
          placeholder="Tambahkan tugas baru..."
          value={title}
          onChange={(e) => setTitle(e.target.value)}
        />

        <button type="submit" className="px-4 py-2 rounded-md bg-indigo-600 text-white flex items-center gap-2">
          <Plus size={16} /> Tambah
        </button>
      </div>

      <div className="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2">
        <input className="rounded-md border px-3 py-2 col-span-2" placeholder="Notes (opsional)" value={notes} onChange={e => setNotes(e.target.value)} />
        <input className="rounded-md border px-3 py-2" type="date" value={due} onChange={e => setDue(e.target.value)} />
        <select className="rounded-md border px-3 py-2" value={priority} onChange={e => setPriority(e.target.value)}>
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
        </select>
        <input className="rounded-md border px-3 py-2" placeholder="tags (pisah koma)" value={tags} onChange={e => setTags(e.target.value)} />
      </div>
    </form>
  );
}

function EditTaskForm({ task, onSave, onCancel }) {
  const [title, setTitle] = useState(task.title);
  const [notes, setNotes] = useState(task.notes || "");
  const [due, setDue] = useState(task.due || "");
  const [priority, setPriority] = useState(task.priority || "Medium");
  const [tags, setTags] = useState((task.tags || []).join(", "));

  function save(e) {
    e.preventDefault();
    onSave({ title: title.trim(), notes: notes.trim(), due: due || null, priority, tags: tags ? tags.split(",").map(s => s.trim()) : [] });
  }

  return (
    <form onSubmit={save} className="border p-3 rounded-md bg-slate-50">
      <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
        <input ref={null} className="col-span-2 rounded-md border px-3 py-2" value={title} onChange={e => setTitle(e.target.value)} />
        <input className="rounded-md border px-3 py-2" type="date" value={due || ""} onChange={e => setDue(e.target.value)} />
        <textarea className="col-span-3 rounded-md border px-3 py-2" rows={2} placeholder="Notes" value={notes} onChange={e => setNotes(e.target.value)} />
        <select className="rounded-md border px-3 py-2" value={priority} onChange={e => setPriority(e.target.value)}>
          <option>Low</option>
          <option>Medium</option>
          <option>High</option>
        </select>
        <input className="rounded-md border px-3 py-2" placeholder="tags (pisah koma)" value={tags} onChange={e => setTags(e.target.value)} />
        <div className="flex gap-2 items-center">
          <button type="submit" className="px-3 py-1 rounded-md bg-green-600 text-white flex items-center gap-2"><Check size={14} /> Simpan</button>
          <button type="button" onClick={onCancel} className="px-3 py-1 rounded-md border">Batal</button>
        </div>
      </div>
    </form>
  );
}
